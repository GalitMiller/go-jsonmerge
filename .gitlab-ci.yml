stages:
- test
- build

before_script:
- mkdir -p $GOPATH/src/github.com/RaveNoX/
- ln -s ./ $GOPATH/src/github.com/RaveNoX/go-jsonmerge
- cd $GOPATH/src/github.com/RaveNoX/go-jsonmerge

after_script:
- rm $GOPATH/src/github.com/RaveNoX/go-jsonmerge

format:
    tags:
    - docker
    - linux
    image: golang:latest
    stage: test
    script:
    - go get -u golang.org/x/tools/cmd/goimports
    # If formatted is different than committed, exit with error    
    - (if [ "$(goimports -l ./)" == "" ]; then echo "Good format"; else echo "Bad format"; exit 33; fi);

metalinter:
    tags:
    - docker
    - linux
    image: golang:latest
    stage: test
    script:
    - go get -u github.com/alecthomas/gometalinter
    - gometalinter -i -u
    - gometalinter ./...

test:
    tags:
    - docker
    - linux
    image: golang:latest
    stage: test
    script:
    - go test -cover -v ./...

compile-linux:
    tags:
    - docker
    - linux
    image: golang:latest
    stage: build
    variables:
        GOOS: linux
        GOARCH: amd64
    script:    
    - mkdir -p artifacts
    - go get -u github.com/kardianos/govendor
    - (cd cmd/jsonmerge && govendor sync)
    - go build cmd/jsonmerge -o artifacts/jsoncommentstrip
    artifacts:
        paths:
        - artifacts/*

compile-windows:
    tags:
    - docker
    - linux
    image: golang:latest
    stage: build
    variables:
        GOOS: windows
        GOARCH: amd64
    script:
    - mkdir -p artifacts
    - go get -u github.com/kardianos/govendor
    - (cd cmd/jsonmerge && govendor sync)
    - go build cmd/jsoncommentstrip -o artifacts/jsoncommentstrip.exe
    artifacts:
        paths:
        - artifacts/*

